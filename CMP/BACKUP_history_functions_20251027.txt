// CMP ì‹¤í–‰ ê¸°ë¡ ì°½ ê´€ë ¨ ì½”ë“œ ë°±ì—… (2025-10-27)
// ë¼ì¸ 4297-4679

        function saveScenarioHistory(scenarioId, historyData) {
            // ì‹œë‚˜ë¦¬ì˜¤ë³„ ê¸°ë¡ ë°°ì—´ ì´ˆê¸°í™”
            if (!scenarioHistories[scenarioId]) {
                scenarioHistories[scenarioId] = [];
            }
            
            // ìƒˆë¡œìš´ ê¸°ë¡ ì¶”ê°€ (ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬)
            const newHistoryEntry = {
                ...historyData,
                id: Date.now() // ê³ ìœ  ID
            };
            
            scenarioHistories[scenarioId].unshift(newHistoryEntry);
            
            console.log(`ğŸ“Š ì‹œë‚˜ë¦¬ì˜¤ ${scenarioId} ì‹¤í–‰ ê¸°ë¡ ì €ì¥:`, {
                totalRecords: scenarioHistories[scenarioId].length,
                newRecord: newHistoryEntry
            });
            
            // ìµœëŒ€ 50ê°œê¹Œì§€ë§Œ ìœ ì§€
            if (scenarioHistories[scenarioId].length > 50) {
                scenarioHistories[scenarioId] = scenarioHistories[scenarioId].slice(0, 50);
            }
            
            // localStorageì— ì €ì¥
            try {
                localStorage.setItem(`cmp-scenario-history-${scenarioId}`, JSON.stringify(scenarioHistories[scenarioId]));
                console.log(`âœ… ì‹œë‚˜ë¦¬ì˜¤ ${scenarioId} ì‹¤í–‰ ê¸°ë¡ localStorage ì €ì¥ ì™„ë£Œ`);
            } catch (error) {
                console.error('ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë¡ì˜ ë¦¬í¬íŠ¸ ê²½ë¡œ ì—…ë°ì´íŠ¸
        function updateScenarioHistoryReportPath(scenarioId, timestamp, reportPath) {
            if (!scenarioHistories[scenarioId]) return;
            
            // í•´ë‹¹ íƒ€ì„ìŠ¤íƒ¬í”„ì˜ ê¸°ë¡ ì°¾ê¸°
            const historyIndex = scenarioHistories[scenarioId].findIndex(history => history.timestamp === timestamp);
            if (historyIndex !== -1) {
                // ë¦¬í¬íŠ¸ ê²½ë¡œ ì—…ë°ì´íŠ¸
                scenarioHistories[scenarioId][historyIndex].reportPath = reportPath;
                
                // localStorageì— ì €ì¥
                try {
                    localStorage.setItem(`cmp-scenario-history-${scenarioId}`, JSON.stringify(scenarioHistories[scenarioId]));
                    console.log(`ì‹œë‚˜ë¦¬ì˜¤ ${scenarioId} ê¸°ë¡ì˜ ë¦¬í¬íŠ¸ ê²½ë¡œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤: ${reportPath}`);
                } catch (error) {
                    console.error('ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë¡ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
                }
            }
        }
        
        // ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ ê¸°ë¡ ì´ˆê¸°í™” (í…ŒìŠ¤íŠ¸ìš©)
        function clearScenarioHistory(scenarioId) {
            try {
                localStorage.removeItem(`cmp-scenario-history-${scenarioId}`);
                scenarioHistories[scenarioId] = [];
                console.log(`ì‹œë‚˜ë¦¬ì˜¤ ${scenarioId} ì‹¤í–‰ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error('ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë¡ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì‚¬ìš©)
        window.clearScenarioHistory = clearScenarioHistory;
        
        // ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ ê¸°ë¡ ì‚­ì œ (ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì‚¬ìš©)
        function clearAllScenarioHistory() {
            try {
                for (let i = 1; i <= 21; i++) {
                    localStorage.removeItem(`cmp-scenario-history-${i}`);
                    if (scenarioHistories[i]) {
                        scenarioHistories[i] = [];
                    }
                }
                console.log('âœ… ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
        window.clearAllScenarioHistory = clearAllScenarioHistory;
        

        
        // íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ ì‹œë‚˜ë¦¬ì˜¤ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ì¸ë±ìŠ¤ íŒŒì¼ ì‚¬ìš©) - VIOLA ë°©ì‹
        async function getScenarioHistoryFromFiles(scenarioId) {
            try {
                // ì‹œë‚˜ë¦¬ì˜¤ ë””ë ‰í† ë¦¬ì˜ index.json íŒŒì¼ì—ì„œ íŒŒì¼ ëª©ë¡ ë¡œë“œ
                const indexResponse = await fetch(`./custom-reports/scenario-${scenarioId}/index.json`);
                
                if (!indexResponse.ok) {
                    console.warn(`ì‹œë‚˜ë¦¬ì˜¤ ${scenarioId}ì˜ ì¸ë±ìŠ¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    return [];
                }
                
                const indexData = await indexResponse.json();
                const reportFiles = indexData.files || [];
                
                console.log(`ğŸ“Š ì‹œë‚˜ë¦¬ì˜¤ ${scenarioId} ì¸ë±ìŠ¤ì—ì„œ ë¡œë“œëœ íŒŒì¼ ìˆ˜:`, reportFiles.length);
                
                const history = [];
                
                for (const file of reportFiles) {
                    const timestampMatch = file.match(/custom-report-(.+)\.html/);
                    if (timestampMatch) {
                        const timestamp = timestampMatch[1];
                        const reportFilePath = `./custom-reports/scenario-${scenarioId}/${file}`;
                        
                        // durationê³¼ status ì¶”ì¶œ
                        const reportInfo = await extractDurationFromReport(reportFilePath);
                        const duration = reportInfo.duration;
                        const durationText = reportInfo.durationText;
                        const status = reportInfo.status || 'completed';
                        
                        history.push({
                            timestamp: timestamp,
                            formattedTimestamp: new Date(timestamp).toLocaleString('ko-KR'),
                            reportPath: reportFilePath,
                            status: status,
                            duration: duration,
                            durationText: durationText
                        });
                    }
                }
                
                return history;
            } catch (error) {
                console.error(`ì‹œë‚˜ë¦¬ì˜¤ ${scenarioId} íˆìŠ¤í† ë¦¬ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:`, error);
                return [];
            }
        }
        
        // ë¦¬í¬íŠ¸ HTMLì—ì„œ durationê³¼ status ì¶”ì¶œ (VIOLA ë°©ì‹)
        async function extractDurationFromReport(reportPath) {
            try {
                console.log(`ğŸ“Š ë¦¬í¬íŠ¸ì—ì„œ durationê³¼ status ì¶”ì¶œ ì‹œë„: ${reportPath}`);
                const response = await fetch(reportPath);
                if (!response.ok) {
                    console.warn(`âš ï¸ ë¦¬í¬íŠ¸ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŒ: ${reportPath}`);
                    return { duration: 0, durationText: 'ì•Œ ìˆ˜ ì—†ìŒ', status: 'completed' };
                }

                const htmlContent = await response.text();

                // Status ì¶”ì¶œ
                let status = 'completed';
                const hasFailStatus = htmlContent.includes('status-badge fail') || htmlContent.includes('class="status-fail"');
                const hasStoppedStatus = htmlContent.includes('stopped') || htmlContent.includes('ì¤‘ë‹¨');
                const hasNotTestStatus = htmlContent.includes('status-not-test');
                const hasPassStatus = htmlContent.includes('status-badge pass') || htmlContent.includes('status-pass');

                if (hasFailStatus || hasStoppedStatus) {
                    status = 'failed';
                } else if (hasNotTestStatus && !hasPassStatus) {
                    status = 'not-run';
                } else if (hasPassStatus) {
                    status = 'completed';
                }

                // Duration ì¶”ì¶œ - ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ íŒ¨í„´ ë¨¼ì € ì‹œë„ (VIOLA ë°©ì‹)
                const patterns = [
                    /ì´\s*ì‹¤í–‰ì‹œê°„[:\s]*(\d+ì´ˆ|\d+ë¶„\s*\d*ì´ˆ|\d+ms)/i,
                    /ì´\s*ì†Œìš”ì‹œê°„[:\s]*(\d+ì´ˆ|\d+ë¶„\s*\d*ì´ˆ|\d+ms)/i,
                    /fa-play.*?ì‹¤í–‰ì‹œê°„[:\s]*(\d+ì´ˆ|\d+ë¶„\s+\d+ì´ˆ|\d+ms)/i,
                    /meta-item.*?ì‹¤í–‰ì‹œê°„[:\s]*(\d+ì´ˆ|\d+ë¶„\s+\d+ì´ˆ|\d+ms)/i,
                    /ì‹¤í–‰ì‹œê°„[:\s]*(\d+ì´ˆ|\d+ë¶„\s+\d+ì´ˆ)(?!ms)/i,
                    /í…ŒìŠ¤íŠ¸\s*ì†Œìš”ì‹œê°„[:\s]*(\d+ì´ˆ|\d+ë¶„\s*\d*ì´ˆ|\d+ms)/i,
                    /ì‹¤í–‰\s*ì†Œìš”ì‹œê°„[:\s]*(\d+ì´ˆ|\d+ë¶„\s*\d*ì´ˆ|\d+ms)/i,
                    /duration[:\s]*(\d+ì´ˆ|\d+ë¶„\s*\d*ì´ˆ|\d+ms)/i
                ];
                
                for (const pattern of patterns) {
                    const match = htmlContent.match(pattern);
                    if (match) {
                        const durationStr = match[1];
                        
                        if (durationStr.includes('ë¶„')) {
                            const minutesMatch = durationStr.match(/(\d+)ë¶„/);
                            const secondsMatch = durationStr.match(/(\d+)ì´ˆ/);
                            
                            const minutes = minutesMatch ? parseInt(minutesMatch[1]) : 0;
                            const seconds = secondsMatch ? parseInt(secondsMatch[1]) : 0;
                            const totalSeconds = minutes * 60 + seconds;
                            
                            return {
                                duration: totalSeconds,
                                durationText: `${minutes}ë¶„ ${seconds}ì´ˆ`,
                                status: status
                            };
                        } else if (durationStr.includes('ì´ˆ')) {
                            const seconds = parseInt(durationStr);
                            const minutes = Math.floor(seconds / 60);
                            const remainingSeconds = seconds % 60;
                            return {
                                duration: seconds,
                                durationText: `${minutes}ë¶„ ${remainingSeconds}ì´ˆ`,
                                status: status
                            };
                        }
                    }
                }

                return { duration: 0, durationText: 'ì•Œ ìˆ˜ ì—†ìŒ', status: status };
            } catch (error) {
                console.warn(`âš ï¸ ë¦¬í¬íŠ¸ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${reportPath}`, error);
                return { duration: 0, durationText: 'ì•Œ ìˆ˜ ì—†ìŒ', status: 'completed' };
            }
        }

        // ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ ê¸°ë¡ ë¡œë“œ
        // íƒ€ì„ìŠ¤íƒ¬í”„ ë³€í™˜ í—¬í¼ í•¨ìˆ˜ (2025-10-17T08-10-58 â†’ Date ê°ì²´)
        function parseTimestamp(timestamp) {
            try {
                // "2025-10-17T08-10-58" í˜•ì‹ì„ "2025-10-17T08:10:58"ë¡œ ë³€í™˜
                const normalized = timestamp.replace(/T(\d{2})-(\d{2})-(\d{2})/, 'T$1:$2:$3');
                const date = new Date(normalized);
                
                if (isNaN(date.getTime())) {
                    console.warn(`âš ï¸ íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì‹± ì‹¤íŒ¨: ${timestamp}`);
                    return new Date(); // fallback to current date
                }
                
                return date;
            } catch (error) {
                console.warn(`âš ï¸ íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì‹± ì˜¤ë¥˜: ${timestamp}`, error);
                return new Date();
            }
        }

        async function loadScenarioHistory(scenarioId) {
            // í˜„ì¬ í™œì„±í™”ëœ íƒ­ì— ë”°ë¼ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆ ì‚¬ìš©
            const isHistoryTab = document.getElementById('history').classList.contains('active');
            const containerId = isHistoryTab ? `history-content-${scenarioId}` : `scenario-history-content-${scenarioId}`;
            const historyContent = document.getElementById(containerId);
            if (!historyContent) return;
            
            try {
                console.log(`ğŸ“Š ì‹œë‚˜ë¦¬ì˜¤ ${scenarioId} ê¸°ë¡ ë¡œë“œ ì‹œì‘ (CMP)`);
                
                // localStorageì—ì„œ ìµœì‹  ì‹¤í–‰ ê¸°ë¡ ë¡œë“œ
                let history = [];
                try {
                    const storedHistory = localStorage.getItem(`cmp-scenario-history-${scenarioId}`);
                    if (storedHistory) {
                        history = JSON.parse(storedHistory);
                        console.log(`ğŸ“Š localStorageì—ì„œ ë¡œë“œëœ ê¸°ë¡ ìˆ˜: ${history.length}`);
                    }
                } catch (error) {
                    console.warn(`âš ï¸ localStorage ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:`, error);
                }
                
                // íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ ë¦¬í¬íŠ¸ íŒŒì¼ë„ ê°€ì ¸ì˜¤ê¸° (ë°±ì—…ìš©)
                if (history.length === 0) {
                    history = await getScenarioHistoryFromFiles(scenarioId);
                    console.log(`ğŸ“Š íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ ë¡œë“œëœ ê¸°ë¡ ìˆ˜: ${history.length}`);
                }
                
                // ê° ê¸°ë¡ì˜ reportPath í™•ì¸
                history.forEach((item, index) => {
                    console.log(`ğŸ“Š ê¸°ë¡ ${index + 1}:`, {
                        timestamp: item.timestamp,
                        timestampType: typeof item.timestamp,
                        timestampDate: parseTimestamp(item.timestamp),
                        status: item.status,
                        reportPath: item.reportPath,
                        reportPathType: typeof item.reportPath,
                        hasReportPath: !!item.reportPath
                    });
                });
                
                if (history.length > 0) {
                                    // ì €ì¥ëœ reportPathë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì´ë¯¸ ì˜¬ë°”ë¥¸ ê²½ë¡œê°€ ì €ì¥ë˜ì–´ ìˆìŒ)
                const updatedHistory = history.map(item => {
                    console.log(`ğŸ“Š ê¸°ë¡ í™•ì¸:`, {
                        timestamp: new Date(item.timestamp).toLocaleString('ko-KR'),
                        status: item.status,
                        reportPath: item.reportPath,
                        hasReportPath: !!item.reportPath,
                        reportPathType: typeof item.reportPath,
                        reportPathLength: item.reportPath ? item.reportPath.length : 0
                    });
                    return item;
                });
                    
                    const historyHtml = updatedHistory.map(item => {
                        let timestamp = 'N/A';
                        try {
                            const date = new Date(item.timestamp);
                            if (!isNaN(date.getTime())) {
                                timestamp = date.toLocaleString('ko-KR');
                            }
                        } catch (e) {
                            console.warn('âš ï¸ timestamp íŒŒì‹± ì‹¤íŒ¨:', item.timestamp);
                        }
                        const statusText = getStatusText(item.status);
                        const statusClass = item.status === 'completed' ? 'success' : 
                                          item.status === 'failed' ? 'error' : 
                                          item.status === 'running' ? 'warning' : 'info';
                        
                        // durationText ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ duration(ì´ˆ) ë³€í™˜
                        let durationText = 'N/A';
                        if (item.durationText && item.durationText !== 'N/A' && item.durationText !== 'ì•Œ ìˆ˜ ì—†ìŒ') {
                            durationText = item.durationText;
                        } else if (item.duration && typeof item.duration === 'number' && item.duration > 0) {
                            if (item.duration < 60) {
                                durationText = `${item.duration}ì´ˆ`;
                            } else {
                                const minutes = Math.floor(item.duration / 60);
                                const seconds = item.duration % 60;
                                durationText = `${minutes}ë¶„ ${seconds}ì´ˆ`;
                            }
                        }
                        
                        return `
                            <div class="history-item">
                                <div class="history-info">
                                    <div class="history-timestamp">
                                        <i class="fas fa-clock"></i>
                                        <span>${timestamp}</span>
                                    </div>
                                    <div class="history-status ${statusClass}">
                                        <i class="fas fa-circle"></i>
                                        <span>${statusText}</span>
                                    </div>
                                    <div class="history-duration">
                                        <i class="fas fa-stopwatch"></i>
                                        <span>${durationText}</span>
                                    </div>
                                </div>
                                <div class="history-actions">
                                    ${item.reportPath ? `
                                        <button class="btn btn-small btn-primary history-report-btn" data-report-path="${item.reportPath}" data-scenario-id="${scenarioId}">
                                            <i class="fas fa-external-link-alt"></i> ë¦¬í¬íŠ¸ ì—´ê¸°
                                    </button>
                                    ` : `
                                        <span class="no-report">ë¦¬í¬íŠ¸ ì—†ìŒ</span>
                                    `}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    historyContent.innerHTML = historyHtml;
                    
                    // ë¦¬í¬íŠ¸ ì—´ê¸° ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    const reportButtons = historyContent.querySelectorAll('.history-report-btn');
                    reportButtons.forEach(button => {
                        button.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const reportPath = this.dataset.reportPath;
                            const scenarioId = parseInt(this.dataset.scenarioId);
                            
                            console.log(`ğŸ” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ!`);
                            console.log(`  - ë²„íŠ¼ ìš”ì†Œ:`, this);
                            console.log(`  - data-report-path:`, reportPath);
                            console.log(`  - data-scenario-id:`, scenarioId);
                            
                            handleHistoryReportClick(reportPath, scenarioId);
                        });
                    });
                    } else {
                    historyContent.innerHTML = `
                        <div class="history-empty">
                            <i class="fas fa-info-circle"></i>
                            <span>ì•„ì§ ì‹¤í–‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                historyContent.innerHTML = `
                    <div class="history-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>ê¸°ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>
                        </div>
                    `;
                }
        }

